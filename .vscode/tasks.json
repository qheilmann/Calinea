{
    // See https://go.microsoft.com/fwlink/?LinkId=733558
    // for the documentation about the tasks.json format
    "version": "2.0.0",

    // On Windows you need to set the default terminal profile to something like "Git Bash" (ctrl+shift+p > workbench.action.terminal.selectDefaultShell > "Git Bash") 

    // Default configuration
    "options": {
        "env": {
            "ENV_FILE": "${workspaceFolder}/.env",
        }
    },
    "presentation": {
        "clear": true
    },
    "problemMatcher": [],

    // Tasks definition
    "tasks": [
        {
            "label": "ResolveBuildCopyPipeline",
            "type": "shell",
            "command": "./gradlew ResolveBuildCopyPipeline",
            "runOptions": {
                "instancePolicy": "terminateOldest",
            },
        },
        {
            "label": "Paper Server run",
            "type": "shell",
            "command": [
                "set a-",
                "&& . \"${ENV_FILE}\"",
                "&& cd \"$SERVER_PATH\"",
                "&& ./start --jar    \"${SERVER_JAR}\"",
                "           --memory \"${SERVER_ALLOCATED_MEMORY}\"",
            ],
            "runOptions": {
                "instancePolicy": "terminateOldest",
            },
        },
        {
            "label": "Paper Server run (HotSwap)",
            "type": "shell",
            "command": [
                "set a-",
                "&& . \"${ENV_FILE}\"",
                "&& cd \"${SERVER_PATH}\"",
                "&& ./start --java   \"${JBR21_HOME}\\bin\\java\"",
                "           --args   \"-XX:+AllowEnhancedClassRedefinition -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=localhost:1000 -Ddisable.watchdog=true\"",
                "           --jar    \"${SERVER_JAR}\"",
                "           --memory \"${SERVER_ALLOCATED_MEMORY}\"",
            ],
            "runOptions": {
                "instancePolicy": "terminateOldest",
            },
        },
        {
            "label": "Stop Paper Server (intermediate)",
            "type": "shell",
            "command": [
                "set a-",
                "&& . \"${ENV_FILE}\"",
                "&& mcrcon.exe -H \"${MCRCON_HOST}\" -P \"${MCRCON_PORT}\" -p \"${MCRCON_PASS}\" stop || echo 'Server not running or already stopped'"
            ],
            "presentation": {
                "reveal": "silent",
                "close": true
            },
            "runOptions": {
                "instancePolicy": "terminateOldest",
            },
            "hide": true
        },
        {
            "label": "Wait for Server Stop (intermediate)",
            "type": "shell",
            "command": "for i in {1..10}; do netstat -ano | grep ':1000 ' | grep 'LISTENING' > /dev/null 2>&1 || break; sleep 1; done && echo 'Server fully stopped'",
            "presentation": {
                "reveal": "silent",
                "close": true
            },
            "runOptions": {
                "instancePolicy": "terminateOldest",
            },
            "hide": true
        },
        {
            "label": "Stop & Build (intermediate)",
            "dependsOrder": "parallel",
            "dependsOn": [
                "Stop Paper Server (intermediate)",
                "ResolveBuildCopyPipeline"
            ],
            "presentation": {
                "reveal": "silent",
                "close": true
            },
            "runOptions": {
                "instancePolicy": "terminateOldest",
            },
            "hide": true
        },
        {
            "label": "Build & Restart Server",
            "dependsOrder": "sequence",
            "dependsOn": [
                "Stop & Build (intermediate)",
                "Wait for Server Stop (intermediate)",
                "Paper Server run (HotSwap)"
            ],
            "runOptions": {
                "instancePolicy": "terminateOldest",
            },
        }
    ]
}